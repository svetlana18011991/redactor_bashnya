<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Башня знаний</title>
  <style>
    :root{ --hud-bg: rgba(10, 12, 18, .7); --panel-bg: rgba(20, 22, 30, .95); --gold: #FFD700; --good: #00C851; --bad: #ff4444; }
    html,body{height:100%;margin:0;font-family:system-ui,sans-serif;background:#000;color:white;overflow:hidden;}
    canvas{width:100%;height:100%;display:block;}
    
    #timerWrap { position: absolute; top:0; left:0; width:100%; height:8px; display:none; z-index:20; background:rgba(255,255,255,0.1); }
    #timerBar { height:100%; width:100%; background: linear-gradient(90deg, #ff9a9e, #ff5252); transition: width 0.1s linear; }
    
    #hud { position:absolute; top:15px; left:15px; right:15px; display:flex; justify-content:space-between; z-index:3; pointer-events:none; }
    .pill { background:var(--hud-bg); border:1px solid rgba(255,255,255,0.2); border-radius:20px; padding:8px 15px; font-weight:bold; backdrop-filter:blur(5px); }
    
    #overlay { position:absolute; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:10; flex-direction:column; backdrop-filter:blur(5px); }
    #card { width:90%; max-width:500px; background:var(--panel-bg); border:2px solid var(--gold); border-radius:15px; padding:25px; text-align:center; box-shadow:0 0 40px rgba(255,215,0,0.2); max-height:90vh; overflow-y:auto; }
    
    #qImg { max-width:100%; max-height:200px; border-radius:8px; margin-bottom:15px; display:none; border:1px solid #555; }
    #qAudio { width:100%; margin-bottom:15px; display:none; }
    #qText { font-size:22px; color:var(--gold); font-weight:bold; margin-bottom:20px; line-height:1.3; }
    
    .ans-grid { display:grid; gap:10px; grid-template-columns:1fr; }
    .ans-grid.cols { grid-template-columns:1fr 1fr; }
    .btn { background:rgba(255,255,255,0.1); border:1px solid var(--gold); color:white; padding:12px; border-radius:8px; cursor:pointer; font-size:16px; transition:0.2s; }
    .btn:hover { background:var(--gold); color:black; }
    
    #inputBox { display:none; }
    input[type=text] { width:70%; padding:10px; background:#222; border:1px solid #555; color:white; font-size:16px; border-radius:5px; }
    
    #msg { margin-top:15px; font-weight:bold; min-height:20px; }
    
    #startScreen, #endScreen { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:20; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    h1 { color:var(--gold); font-size:40px; margin-bottom:10px; text-shadow:0 0 15px var(--gold); }
    .big-btn { background:var(--gold); color:black; border:none; padding:15px 40px; font-size:20px; border-radius:30px; font-weight:bold; cursor:pointer; margin-top:20px; box-shadow:0 0 20px var(--gold); transition:0.3s; }
    .big-btn:hover { transform:scale(1.05); }
    .hidden { display:none !important; }
  </style>
</head>
<body>

<div id="wrap">
  <canvas id="c"></canvas>
  <div id="timerWrap"><div id="timerBar"></div></div>
  <div id="hud">
    <div class="pill">Блоков: <span id="floorVal">0</span></div>
    <div class="pill">Счёт: <span id="scoreVal">0</span></div>
  </div>

  <div id="overlay">
    <div id="card">
      <img id="qImg">
      <audio id="qAudio" controls></audio>
      <div id="qText"></div>
      <div id="ansBox" class="ans-grid"></div>
      <div id="inputBox">
        <input type="text" id="ansInput" placeholder="Ответ...">
        <button class="btn" onclick="checkInput()">OK</button>
      </div>
      <div id="msg"></div>
    </div>
  </div>

  <div id="startScreen">
    <h1>БАШНЯ ЗНАНИЙ</h1>
    <p style="color:#ccc; max-width:400px;">Отвечай верно, чтобы построить башню.<br>Ошибешься — блок взорвется.</p>
    <button class="big-btn" onclick="startGame()">ИГРАТЬ</button>
  </div>

  <div id="endScreen" class="hidden">
    <h1 id="endTitle">ФИНАЛ</h1>
    <p>Счёт: <b id="finalScore" style="color:var(--gold); font-size:24px;">0</b></p>
    <button class="big-btn" onclick="location.reload()">ЗАНОВО</button>
  </div>
</div>

<script>
// --- КОНФИГУРАЦИЯ ---
const REPO = "https://svetlana18011991.github.io/redactor_bashnya/";
const BLOCK_IMGS = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];
let QS = [{type:"choice",q:"2+2=?",options:["3","4","5"],answer:"4"}]; // Default
let BG_SRC = REPO + "1.png";

// ЧТЕНИЕ ВНЕДРЕННЫХ ДАННЫХ (ОТ РЕДАКТОРА)
if(window.INJECTED_DATA) {
    if(window.INJECTED_DATA.qs && window.INJECTED_DATA.qs.length) QS = window.INJECTED_DATA.qs;
    if(window.INJECTED_DATA.bg) BG_SRC = window.INJECTED_DATA.bg;
} else {
    // Чтение из URL (старый метод для совместимости)
    try {
        const p = new URLSearchParams(location.search).get('data');
        if(p) {
            const d = JSON.parse(decodeURIComponent(escape(atob(p))));
            if(d.qs) QS = d.qs;
            if(d.bg) BG_SRC = d.bg;
        }
    } catch(e){}
}

// --- ДВИЖОК ---
const cvs = document.getElementById("c"), ctx = cvs.getContext("2d");
let W, H;
const resize = ()=>{ W=cvs.width=window.innerWidth; H=cvs.height=window.innerHeight; };
window.addEventListener("resize", resize); resize();

const ASSETS = { blocks: [], bg: null };
const load = (src) => new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=(src.includes('data:')||src.includes('http'))?src:REPO+src; });

async function init() {
    ASSETS.bg = await load(BG_SRC);
    for(let f of BLOCK_IMGS) ASSETS.blocks.push(await load(f));
}
init();

const game = { run: false, tower: [], curr: null, score: 0, qIdx: 0, camY: 0, parts: [], wait: false };

function startGame() {
    document.getElementById('startScreen').classList.add('hidden');
    game.run = true; game.tower = []; game.score = 0; game.qIdx = 0; game.camY = 0;
    updHUD(); spawn(); loop();
}

function spawn() {
    if(game.qIdx >= 9) { end(true); return; }
    const img = ASSETS.blocks[Math.floor(Math.random()*ASSETS.blocks.length)];
    
    // ФИКС СКАЧКА: Инициализируем X сразу в позиции синусоиды для текущего времени
    // Но для плавности просто ставим по центру и даем фазу 0
    // Или лучше: используем startTime для синуса
    
    game.curr = {
        img: img,
        x: W/2 - 50, y: -100, w: 100, h: 60,
        speed: 300 + (game.tower.length*20),
        stop: false,
        birth: Date.now() // для синхронизации
    };
    game.wait = false;
}

function updHUD() {
    document.getElementById('floorVal').innerText = game.tower.length;
    document.getElementById('scoreVal').innerText = game.score;
}

// Input
cvs.onmousedown = cvs.ontouchstart = (e) => { 
    if(e.type==='touchstart') e.preventDefault();
    if(game.run && game.curr && !game.curr.stop && !game.wait) {
        game.curr.stop = true;
        ask();
    }
};

// --- ВОПРОСЫ ---
let timerInt = null;
function ask() {
    game.wait = true;
    const q = QS[game.qIdx % QS.length];
    
    const card = document.getElementById('card');
    const qText = document.getElementById('qText');
    const img = document.getElementById('qImg');
    const aud = document.getElementById('qAudio');
    const ansBox = document.getElementById('ansBox');
    const inpBox = document.getElementById('inputBox');
    const msg = document.getElementById('msg');

    msg.innerText = "";
    qText.innerText = q.q;
    
    img.style.display = q.img ? 'block' : 'none';
    if(q.img) img.src = q.img;
    
    aud.style.display = q.audio ? 'block' : 'none';
    if(q.audio) aud.src = q.audio; else aud.pause();

    ansBox.innerHTML = '';
    if(q.type === 'choice') {
        ansBox.style.display = 'grid'; inpBox.style.display = 'none';
        ansBox.className = q.options.length > 4 ? 'ans-grid cols' : 'ans-grid';
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn'; btn.innerText = opt;
            btn.onclick = () => answer(opt === q.answer);
            ansBox.appendChild(btn);
        });
    } else {
        ansBox.style.display = 'none'; inpBox.style.display = 'block';
        const inp = document.getElementById('ansInput');
        inp.value = ''; inp.dataset.ans = q.answer; inp.focus();
    }

    document.getElementById('overlay').style.display = 'flex';
    
    if(q.timer) startTimer(q.timer);
    else document.getElementById('timerWrap').style.display = 'none';
}

function startTimer(s) {
    const bar = document.getElementById('timerBar');
    const wrap = document.getElementById('timerWrap');
    wrap.style.display = 'block'; bar.style.width = '100%';
    let left = s;
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(() => {
        left -= 0.1;
        bar.style.width = (left/s*100) + "%";
        if(left <= 0) { clearInterval(timerInt); answer(false); }
    }, 100);
}

function checkInput() {
    const inp = document.getElementById('ansInput');
    answer(inp.value.trim().toLowerCase() === inp.dataset.ans.trim().toLowerCase());
}

function answer(win) {
    if(timerInt) clearInterval(timerInt);
    document.getElementById('timerWrap').style.display = 'none';
    const msg = document.getElementById('msg');
    
    if(win) {
        msg.innerText = "ВЕРНО!"; msg.style.color = "var(--good)";
        game.score += 100;
        setTimeout(() => { closeAsk(); drop(); }, 1000);
    } else {
        msg.innerText = "НЕВЕРНО! Блок сгорает."; msg.style.color = "var(--bad)";
        setTimeout(() => { closeAsk(); boom(); }, 1500);
    }
}

function closeAsk() { document.getElementById('overlay').style.display = 'none'; game.qIdx++; }

// --- ФИЗИКА ---
function drop() {
    const b = game.curr;
    let landY = H - 50;
    if(game.tower.length) landY = game.tower[game.tower.length-1].y;
    b.y = landY - b.h;
    game.tower.push(b);
    game.curr = null;
    updHUD();
    if(game.tower.length > 3) game.camY += 60;
    setTimeout(spawn, 500);
}

function boom() {
    const b = game.curr;
    for(let i=0; i<15; i++) game.parts.push({ x: b.x+b.w/2, y: b.y+b.h/2, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1 });
    game.curr = null;
    setTimeout(spawn, 500);
}

function end(win) {
    game.run = false;
    document.getElementById('endScreen').classList.remove('hidden');
    document.getElementById('endTitle').innerText = win ? "ПОБЕДА!" : "ФИНАЛ";
    document.getElementById('finalScore').innerText = game.score;
}

function loop() {
    if(!game.run) return;
    requestAnimationFrame(loop);
    ctx.clearRect(0,0,W,H);
    
    // BG
    if(ASSETS.bg) {
        const s = Math.max(W/ASSETS.bg.width, H/ASSETS.bg.height);
        ctx.drawImage(ASSETS.bg, (W-ASSETS.bg.width*s)/2, (H-ASSETS.bg.height*s)/2, ASSETS.bg.width*s, ASSETS.bg.height*s);
    } else { ctx.fillStyle="#111"; ctx.fillRect(0,0,W,H); }

    ctx.save();
    ctx.translate(0, game.camY);

    game.tower.forEach(b => ctx.drawImage(b.img, b.x, b.y, b.w, b.h));

    if(game.curr) {
        const b = game.curr;
        if(!b.stop) {
            // Исправленная формула без скачка (используем разницу времени)
            // Центр экрана (W/2) - половина блока (b.w/2) + синус
            b.x = (W/2 - b.w/2) + Math.sin((Date.now())/300) * (W/2 - 60);
            
            // Летит над башней
            let targetY = H - 150;
            if(game.tower.length) targetY = game.tower[game.tower.length-1].y - 150;
            b.y += (targetY - b.y) * 0.1; // Плавный подлет по Y
        }
        ctx.drawImage(b.img, b.x, b.y, b.w, b.h);
    }

    game.parts.forEach((p,i) => {
        p.x+=p.vx; p.y+=p.vy; p.life-=0.05;
        ctx.fillStyle=`rgba(255,100,50,${p.life})`; ctx.fillRect(p.x,p.y,6,6);
        if(p.life<=0) game.parts.splice(i,1);
    });

    ctx.restore();
    ctx.fillStyle="#222"; ctx.fillRect(0, H-50+game.camY, W, 50);
}
</script>
</body>
</html>
