<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tower Game</title>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;background:#051024;overflow:hidden;font-family:'Segoe UI',sans-serif;color:white;user-select:none;}
    body{position:relative;}
    canvas{position:fixed;inset:0;display:block;width:100vw;height:100vh;touch-action:none;}
    
    #ui{position:absolute;top:15px;left:15px;right:15px;display:flex;justify-content:space-between;pointer-events:none;z-index:5;}
    .hud{background:rgba(0,0,0,0.6);padding:8px 20px;border-radius:30px;border:2px solid #FFD700;font-weight:bold;font-size:18px;text-shadow:0 2px 2px black;}
    
    #overlay{position:absolute;inset:0;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:20;}
    #card{background:#1a202c;border:2px solid #FFD700;padding:25px;width:90%;max-width:400px;text-align:center;border-radius:15px;box-shadow:0 0 50px rgba(255, 215, 0, 0.2);}
    
    #qImg{max-width:100%;max-height:200px;display:none;margin:0 auto 15px;border-radius:8px;border:1px solid #555;}
    #qTxt{margin-bottom:20px;font-size:20px;font-weight:bold;color:#FFD700;line-height:1.4;}
    
    .btn{background:linear-gradient(to bottom, #444, #222);color:white;border:1px solid #666;padding:12px;width:100%;margin:8px 0;cursor:pointer;border-radius:8px;font-size:16px;transition:0.2s;}
    .btn:hover{background:#FFD700;color:black;border-color:#FFD700;transform:scale(1.02);}
    
    #inp{width:100%;padding:12px;display:none;margin-bottom:15px;border-radius:8px;border:1px solid #FFD700;background:#000;color:white;font-size:16px;box-sizing:border-box;}
    #msg{margin-top:15px;font-weight:bold;height:24px;font-size:18px;}
    
    #timerBar{height:6px;background:linear-gradient(to right, #f00, #f80);width:100%;position:absolute;top:0;left:0;display:none;z-index:30;}
    
    #screen{position:absolute;inset:0;background:rgba(5,16,36,0.98);z-index:50;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
    h1{font-size:40px;color:#FFD700;margin:0 0 10px;text-transform:uppercase;letter-spacing:2px;}
    .big-btn{background:#FFD700;color:black;border:none;padding:15px 50px;font-size:22px;border-radius:50px;font-weight:bold;cursor:pointer;margin-top:30px;box-shadow:0 0 30px rgba(255,215,0,0.4);transition:0.3s;}
    .big-btn:hover{transform:scale(1.1);}
    .big-btn:disabled{background:#555;color:#888;cursor:wait;transform:none;}
    
    #ver { position: absolute; bottom: 5px; left: 5px; font-size: 10px; color: #555; pointer-events: none; }
    #loader { color: gold; margin-top:10px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="ver">v13.0 (GENIALLY FIX)</div>
  <div id="timerBar"></div>
  
  <div id="ui">
    <div class="hud">Этаж: <span id="hFloor">0</span></div>
    <div class="hud">Счет: <span id="hScore">0</span></div>
  </div>
  
  <canvas id="c"></canvas>

  <div id="overlay">
    <div id="card">
      <img id="qImg">
      <div id="qTxt"></div>
      <div id="ansBox"></div>
      <input type="text" id="inp" placeholder="Введите ответ...">
      <button class="btn" id="okBtn" style="display:none;background:#FFD700;color:black;font-weight:bold;" onclick="check()">ОТВЕТИТЬ</button>
      <div id="msg"></div>
    </div>
  </div>

  <div id="screen">
    <h1 id="title">БАШНЯ</h1>
    <p id="desc" style="color:#aaa;max-width:300px;line-height:1.5;">Построй башню за 9 ходов.<br>Ошибка = блок сгорает.</p>
    <button id="startBtn" class="big-btn" onclick="startGame()" disabled>ЗАГРУЗКА...</button>
    <div id="loader"></div>
  </div>

<script>
// === КОНФИГУРАЦИЯ GENIALLY ===
// Прямая ссылка на репозиторий. Это критически важно для Genially.
const REPO_URL = "https://svetlana18011991.github.io/redactor_bashnya/";
const IMGS = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

let DATA = { qs: [{type:'choice',q:'2+2?',options:['3','4'],answer:'4'}], bg: null, music: null, shuffle: false };

if(window.GAME_CFG) DATA = window.GAME_CFG;

const c = document.getElementById('c');
const ctx = c.getContext('2d');
let W, H;
let timerInt = null;
const audio = new Audio();
const assets = { b: [], bg: null };

// === ДВИЖОК ===
let lastW = null, lastH = null;
function resize() {
    const dpr = window.devicePixelRatio || 1;
    const newW = Math.max(1, window.innerWidth);
    const newH = Math.max(1, window.innerHeight);

    c.width  = Math.round(newW * dpr);
    c.height = Math.round(newH * dpr);
    c.style.width = newW + "px";
    c.style.height = newH + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    W = newW; H = newH;
    
    // Пересчет позиций для стабильности
    if (lastH !== null && game) {
        const groundY = H - 50;
        if (game.tower && game.tower.length) {
            const base = game.tower[0];
            const dy = (groundY - base.h) - base.y;
            if (dy) {
                game.tower.forEach(b => b.y += dy);
                if (game.curr && game.curr.state !== 'drop') game.curr.y += dy;
            }
        }
        if (lastW !== null) {
            const cx = W / 2;
            if (game.tower) game.tower.forEach(b => b.x = cx - b.w / 2);
            if (game.curr) game.curr.x = cx - game.curr.w / 2;
        }
    }
    lastW = W; lastH = H;
}
window.addEventListener('resize', resize, { passive: true });
resize();

// Загрузчик с таймаутом (чтобы игра не висла в Genially)
const load = (src) => new Promise(resolve => {
    if(!src) { resolve({ok:false}); return; }
    
    // Если ссылка полная (http) или base64 - берем как есть. Иначе клеим REPO_URL
    const fullSrc = (src.startsWith('data:') || src.startsWith('http')) ? src : REPO_URL + src;
    
    const img = new Image();
    img.crossOrigin = "Anonymous"; // Важно для Genially!
    
    let done = false;
    
    img.onload = () => {
        if(done) return; done = true;
        resolve({ ok: true, img: img });
    };
    
    img.onerror = () => {
        if(done) return; done = true;
        console.warn("Error loading:", fullSrc);
        resolve({ ok: false, src: src });
    };
    
    img.src = fullSrc;
    
    // Тайм-аут 3 секунды. Если картинка не грузится - пропускаем её, чтобы игра работала.
    setTimeout(() => {
        if(done) return; done = true;
        console.warn("Timeout loading:", fullSrc);
        resolve({ ok: false, src: src });
    }, 3000);
});

async function init() {
    const loader = document.getElementById('loader');
    const btn = document.getElementById('startBtn');
    
    // 1. Фон
    if(DATA.bg) {
        const res = await load(DATA.bg);
        if(res.ok) assets.bg = res.img;
        else if(!DATA.bg.startsWith('data:')) {
            // Фолбэк на дефолт, если кастомный не загрузился
            const defBg = await load("1.png");
            if(defBg.ok) assets.bg = defBg.img;
        }
    } else {
        const res = await load("1.png");
        if(res.ok) assets.bg = res.img;
    }
    
    // 2. Блоки
    let count = 0;
    for(let f of IMGS) {
        loader.innerText = `Загрузка ресурсов ${Math.round((count/IMGS.length)*100)}%`;
        const res = await load(f);
        if(res.ok) assets.b.push(res.img);
        else assets.b.push({ error: true, name: f });
        count++;
    }
    
    loader.innerText = "";
    btn.disabled = false;
    btn.innerText = "ИГРАТЬ";
    btn.style.cursor = "pointer";
    
    if(DATA.shuffle && DATA.qs.length) {
        for(let i=DATA.qs.length-1; i>0; i--) {
            const j=Math.floor(Math.random()*(i+1));
            [DATA.qs[i], DATA.qs[j]] = [DATA.qs[j], DATA.qs[i]];
        }
    }
    loop();
}

let game = { tower: [], curr: null, score: 0, attempt: 0, particles: [], smokes: [] };

function startGame() {
    document.getElementById('screen').style.display = 'none';
    if(DATA.music) { audio.src = DATA.music; audio.volume = 0.3; audio.loop = true; audio.play().catch(()=>{}); }
    game.tower = []; game.score = 0; game.attempt = 0;
    updUI(); spawn();
}

function spawn() {
    if(game.attempt >= 9) { endGame(); return; }
    
    const imgIdx = game.attempt % (assets.b.length || 1);
    const asset = assets.b.length ? assets.b[imgIdx] : null;
    
    const maxH = (H - 250) / 9; 
    let scale = 0.6;
    let w=120, h=60, imgObj=null, errName=null;

    if(asset && !asset.error) {
        imgObj = asset;
        if(imgObj.height * scale > maxH) scale = maxH / imgObj.height;
        w = imgObj.width * scale;
        h = imgObj.height * scale;
    } else if(asset && asset.error) {
        errName = asset.name;
    }

    game.curr = {
        img: imgObj, error: errName,
        w: w, h: h, 
        x: W/2 - w/2, y: -200, 
        state: 'drop',
        char: 0, shake: 0
    };
}

function endGame() {
    document.getElementById('screen').style.display = 'flex';
    document.getElementById('title').innerText = "ФИНАЛ";
    document.getElementById('desc').innerHTML = `Высота: ${game.tower.length}<br>Счет: ${game.score}`;
    document.querySelector('#screen button').innerText = "ЗАНОВО";
    document.querySelector('#screen button').onclick = () => location.reload();
}

function update() {
    if(game.curr) {
        const b = game.curr;
        const groundY = H - 50; 
        
        let landY = groundY - b.h; 
        if(game.tower.length > 0) {
            landY = game.tower[game.tower.length-1].y - b.h + 5; 
        }

        if(b.state === 'drop') {
            let hoverY = H - 300; 
            if(game.tower.length > 0) hoverY = game.tower[game.tower.length-1].y - 120;
            if(hoverY < 50) hoverY = 50;

            b.y += 12;
            if(b.y >= hoverY) {
                b.y = hoverY;
                b.state = 'wait';
                ask();
            }
        }
        else if(b.state === 'fall') {
            b.y += 25;
            if(b.y >= landY) {
                b.y = landY;
                game.tower.push(b);
                game.score += 100;
                game.curr = null;
                game.attempt++;
                updUI();
                setTimeout(spawn, 300);
            }
        }
        else if(b.state === 'burn') {
            b.char += 0.015;
            b.shake = (Math.random()-0.5) * 10;
            if(Math.random()>0.6) {
                game.smokes.push({
                    x: b.x + Math.random()*b.w, y: b.y + Math.random()*b.h,
                    vx: (Math.random()-0.5)*2, vy: -2 - Math.random()*2,
                    life: 1, size: 5+Math.random()*10
                });
            }
            if(b.char >= 1) boom(); 
        }
    }

    for(let i=game.particles.length-1; i>=0; i--) {
        let p = game.particles[i];
        p.x+=p.vx; p.y+=p.vy; p.life-=0.02;
        if(p.life<=0) game.particles.splice(i,1);
    }
    for(let i=game.smokes.length-1; i>=0; i--) {
        let s = game.smokes[i];
        s.x+=s.vx; s.y+=s.vy; s.life-=0.02;
        if(s.life<=0) game.smokes.splice(i,1);
    }
}

function updUI() {
    document.getElementById('hFloor').innerText = game.tower.length;
    document.getElementById('hScore').innerText = game.score;
}

function drawError(x,y,w,h,n) {
    ctx.fillStyle="#444"; ctx.fillRect(x,y,w,h);
    ctx.strokeStyle="red"; ctx.lineWidth=2; ctx.strokeRect(x,y,w,h);
    ctx.fillStyle="white"; ctx.font="10px sans-serif"; ctx.fillText(n||"Err", x+5, y+15);
}

function draw() {
    ctx.clearRect(0,0,W,H);
    
    if(assets.bg && !assets.bg.error) {
        const sc = Math.max(W/assets.bg.width, H/assets.bg.height);
        ctx.drawImage(assets.bg, (W-assets.bg.width*sc)/2, (H-assets.bg.height*sc)/2, assets.bg.width*sc, assets.bg.height*sc);
    } else { ctx.fillStyle="#112"; ctx.fillRect(0,0,W,H); }

    ctx.fillStyle="#222"; ctx.fillRect(0, H-50, W, 50);

    game.tower.forEach(b => {
        if(b.img) ctx.drawImage(b.img, b.x, b.y, b.w, b.h);
        else drawError(b.x, b.y, b.w, b.h, b.error);
    });

    if(game.curr) {
        const b = game.curr;
        const dx = b.x + (b.state === 'burn' ? b.shake : 0);
        
        if(b.img) ctx.drawImage(b.img, dx, b.y, b.w, b.h);
        else drawError(dx, b.y, b.w, b.h, b.error);

        if(b.state === 'burn') {
            ctx.globalCompositeOperation = "source-atop";
            ctx.fillStyle = `rgba(0,0,0,${b.char * 0.9})`; 
            ctx.fillRect(dx, b.y, b.w, b.h);
            ctx.globalCompositeOperation = "lighter";
            ctx.fillStyle = `rgba(255, 100, 0, ${b.char * 0.6})`;
            ctx.fillRect(dx, b.y, b.w, b.h);
            ctx.globalCompositeOperation = "source-over";
        }
    }

    game.smokes.forEach(s => {
        ctx.fillStyle=`rgba(80,80,80,${s.life*0.6})`;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, 7); ctx.fill();
    });

    game.particles.forEach(p => {
        ctx.fillStyle=p.color; ctx.globalAlpha=p.life;
        ctx.fillRect(p.x, p.y, p.size, p.size);
    });
    ctx.globalAlpha=1;
}

function loop() {
    requestAnimationFrame(loop);
    update();
    draw();
}

function ask() {
    if(!DATA.qs || !DATA.qs.length) return; 
    const q = DATA.qs[game.attempt % DATA.qs.length];
    
    const ui = document.getElementById('overlay');
    ui.style.display = 'flex';
    document.getElementById('qTxt').innerText = q.q;
    document.getElementById('msg').innerText = "";
    
    const img = document.getElementById('qImg');
    img.style.display = q.img ? 'block' : 'none';
    if(q.img) img.src = q.img;

    const box = document.getElementById('ansBox');
    const inp = document.getElementById('inp');
    const ok = document.getElementById('okBtn');
    
    box.innerHTML = '';
    if(q.type === 'choice') {
        inp.style.display='none'; ok.style.display='none';
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerText = opt;
            btn.onclick = () => answer(opt === q.answer);
            box.appendChild(btn);
        });
    } else {
        inp.style.display='block'; ok.style.display='block';
        box.style.display='none';
        inp.value = ''; inp.dataset.ans = q.answer;
        inp.focus();
    }

    if(q.timer) startTimer(q.timer);
}

function startTimer(sec) {
    const bar = document.getElementById('timerBar');
    bar.style.display = 'block'; bar.style.width = '100%';
    let t = sec;
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(() => {
        t -= 0.1;
        bar.style.width = (t/sec*100) + '%';
        if(t <= 0) { clearInterval(timerInt); answer(false); }
    }, 100);
}

function check() {
    const v = document.getElementById('inp').value.trim().toLowerCase();
    const a = document.getElementById('inp').dataset.ans.trim().toLowerCase();
    answer(v === a);
}

function answer(win) {
    if(timerInt) clearInterval(timerInt);
    document.getElementById('timerBar').style.display='none';
    const msg = document.getElementById('msg');
    
    if(win) {
        msg.innerText = "ВЕРНО!"; msg.style.color = "#0f0";
        setTimeout(() => {
            document.getElementById('overlay').style.display='none';
            if(game.curr) game.curr.state = 'fall';
        }, 1000);
    } else {
        msg.innerText = "ОШИБКА! Блок сгорает..."; msg.style.color = "#f00";
        setTimeout(() => {
            document.getElementById('overlay').style.display='none';
            if(game.curr) game.curr.state = 'burn';
        }, 1500);
    }
}

function boom() {
    const b = game.curr;
    for(let i=0; i<40; i++) {
        game.particles.push({
            x: b.x + b.w/2, y: b.y + b.h/2,
            vx: (Math.random()-0.5)*20, 
            vy: (Math.random()-0.5)*20,
            life: 1, 
            color: `rgba(255, ${Math.random()*200}, 0, 1)`,
            size: Math.random()*6 + 2
        });
    }
    game.curr = null;
    game.attempt++;
    updUI();
    setTimeout(spawn, 500);
}

init();
</script>
</body>
</html>
