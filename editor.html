<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Editor - Final Genially</title>
    <style>
        :root { --bg: #051024; --panel: #0b1a36; --gold: #FFD700; --text: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: 420px; background: var(--panel); border-right: 2px solid var(--gold); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        
        h1 { font-size: 20px; text-align: center; border-bottom: 1px solid var(--gold); padding-bottom: 15px; color: var(--gold); margin-top: 0; }
        
        .group { background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 6px; padding: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 13px; color: var(--gold); margin-bottom: 5px; font-weight: bold; }
        
        button { background: #444; color: white; border: 1px solid #666; padding: 8px; width: 100%; cursor: pointer; border-radius: 4px; transition: 0.2s; margin-bottom: 5px; }
        button:hover { background: var(--gold); color: black; }
        
        .btn-main { background: var(--gold); color: black; font-weight: bold; border: none; padding: 12px; margin-top: 15px; }
        
        #qList { flex: 1; overflow-y: auto; margin: 20px 0; border-top: 1px solid rgba(255,215,0,0.2); }
        .q-item { background: rgba(255,255,255,0.05); border-left: 3px solid var(--gold); padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .q-item:hover { background: rgba(255,255,255,0.1); }

        .preview-area { flex: 1; background: #000; display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; background: #000; }
        
        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: var(--panel); border: 2px solid var(--gold); width: 500px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 10px; }
        input, select { width: 100%; padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; color: #000; margin-bottom: 10px; }
        .row { display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>üèó –ö–û–ù–°–¢–†–£–ö–¢–û–† (Final)</h1>
    
    <div class="group">
        <label>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–∞ –∏ –º—É–∑—ã–∫–∏</label>
        <button onclick="document.getElementById('bgFile').click()">üñº –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
        <input type="file" id="bgFile" accept="image/*" hidden onchange="handleFile('bg', this)">
        <div id="st_bg" style="font-size:11px; color:#aaa;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</div>
        
        <button onclick="document.getElementById('musicFile').click()">üéµ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º—É–∑—ã–∫—É</button>
        <input type="file" id="musicFile" accept="audio/*" hidden onchange="handleFile('music', this)">
        <div id="st_music" style="font-size:11px; color:#aaa;">–ù–µ—Ç</div>
        
        <label style="margin-top:10px;">–ü–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
        <select id="shuffleMode" onchange="updatePreview()">
            <option value="false">–ü–æ –ø–æ—Ä—è–¥–∫—É</option>
            <option value="true">–°–ª—É—á–∞–π–Ω—ã–π</option>
        </select>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:white; font-size:14px;">2. –í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>)</h3>
        <button style="width:auto;" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="qList"></div>
    
    <div style="margin-top:auto;">
        <button class="btn-main" onclick="copyCode()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î –î–õ–Ø GENIALLY</button>
    </div>
</div>

<div class="preview-area">
    <div style="background:var(--gold); color:black; padding:5px; text-align:center; font-weight:bold; font-size:12px;">–ü–†–ï–î–ü–†–û–°–ú–û–¢–†</div>
    <iframe id="gameFrame" allow="autoplay"></iframe>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <h2 style="text-align:center; color:var(--gold); margin-top:0;">–í–æ–ø—Ä–æ—Å</h2>
        
        <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞:</label>
        <select id="mType" onchange="toggleType()"><option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option><option value="input">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞/—á–∏—Å–ª–∞</option></select>
        
        <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
        <input type="text" id="mText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2 + 2 = ?">
        
        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <div class="row">
            <button onclick="document.getElementById('mImg').click()">üì∑ –í—ã–±—Ä–∞—Ç—å</button>
            <input type="file" id="mImg" accept="image/*" hidden onchange="handleMedia(this)">
            <span id="stImg" style="color:#aaa; font-size:12px;">–ù–µ—Ç</span>
            <button style="width:auto;" onclick="clearMedia()">‚ùå</button>
        </div>

        <div style="margin:10px 0; background:rgba(255,255,255,0.1); padding:8px; border-radius:4px;">
            <input type="checkbox" id="mTimer" style="width:auto;" onchange="toggleTimer()">
            <label style="display:inline; color:white;">–¢–∞–π–º–µ—Ä (—Å–µ–∫—É–Ω–¥—ã)</label>
            <input type="number" id="mSec" value="15" style="width:60px; display:none; margin-left:10px;">
        </div>

        <div id="boxChoice">
            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã (–æ—Ç–º–µ—Ç—å—Ç–µ –≤–µ—Ä–Ω—ã–π —Ç–æ—á–∫–æ–π):</label>
            <div id="ansList"></div>
            <button style="margin-top:5px;" onclick="addAnsRow()">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
        </div>
        
        <div id="boxInput" style="display:none;">
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
            <input type="text" id="mCorrect">
        </div>
        
        <div class="row" style="margin-top:20px; justify-content:flex-end;">
            <button style="background:#444;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-main" style="margin:0;" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
    </div>
</div>

<script>
    let qs = [], editIdx = null, assets = { bg: null, music: null }, tempImg = null;

    function handleFile(k, i) { 
        if(!i.files[0]) return; 
        const r = new FileReader(); r.onload=e=>{ assets[k]=e.target.result; document.getElementById('st_'+k).innerText="–ó–∞–≥—Ä—É–∂–µ–Ω"; document.getElementById('st_'+k).style.color="#0f0"; updatePreview(); }; r.readAsDataURL(i.files[0]); 
    }
    
    function handleMedia(i) { 
        if(!i.files[0]) return; 
        const r = new FileReader(); r.onload=e=>{ tempImg=e.target.result; document.getElementById('stImg').innerText="–ó–∞–≥—Ä—É–∂–µ–Ω"; }; r.readAsDataURL(i.files[0]); 
    }
    function clearMedia() { tempImg=null; document.getElementById('stImg').innerText="–ù–µ—Ç"; }

    function openModal(item=null, idx=null) {
        document.getElementById('modal').style.display='flex';
        tempImg=null; document.getElementById('ansList').innerHTML=""; document.getElementById('stImg').innerText="–ù–µ—Ç";
        
        if(item) {
            editIdx=idx; document.getElementById('mType').value=item.type; document.getElementById('mText').value=item.q;
            document.getElementById('mTimer').checked=!!item.timer; document.getElementById('mSec').value=item.timer||15;
            if(item.img) { tempImg=item.img; document.getElementById('stImg').innerText="–û–ö"; }
            if(item.type==='choice') item.options.forEach(o=>addAnsRow(o,o===item.answer));
            else document.getElementById('mCorrect').value=item.answer;
        } else {
            editIdx=null; document.getElementById('mType').value='choice'; document.getElementById('mText').value=""; 
            document.getElementById('mTimer').checked=false; addAnsRow('',true); addAnsRow('');
        }
        toggleType(); toggleTimer();
    }
    function closeModal(){ document.getElementById('modal').style.display='none'; }
    function toggleTimer(){ document.getElementById('mSec').style.display=document.getElementById('mTimer').checked?'inline-block':'none'; }
    function toggleType(){ 
        const isCh=document.getElementById('mType').value==='choice'; 
        document.getElementById('boxChoice').style.display=isCh?'block':'none'; 
        document.getElementById('boxInput').style.display=isCh?'none':'block'; 
    }
    
    function addAnsRow(val='', ok=false) {
        const d=document.createElement('div'); d.className='row'; d.style.marginBottom='5px';
        d.innerHTML=`<input type="radio" name="rad" style="width:auto;" ${ok?'checked':''}><input type="text" class="ans-val" value="${val}"><button style="width:30px;" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('ansList').appendChild(d);
    }
    
    function saveQ() {
        const q={ type:document.getElementById('mType').value, q:document.getElementById('mText').value, img:tempImg, timer:document.getElementById('mTimer').checked?parseInt(document.getElementById('mSec').value):null };
        if(!q.q.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å");
        
        if(q.type==='choice') {
            const r=document.querySelectorAll('.ans-val');
            q.options=[]; let hasOk=false;
            r.forEach(x=>{ if(x.value.trim()) { q.options.push(x.value.trim()); if(x.parentElement.querySelector('input[type=radio]').checked) { q.answer=x.value.trim(); hasOk=true; } } });
            if(q.options.length<2) return alert("–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞");
            if(!hasOk) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç");
        } else { q.answer=document.getElementById('mCorrect').value.trim(); if(!q.answer) return alert("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"); }
        
        if(editIdx!==null) qs[editIdx]=q; else qs.push(q);
        closeModal(); render(); updatePreview();
    }
    
    function deleteQ(i) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")){ qs.splice(i,1); render(); updatePreview(); } }
    
    function render() {
        const l=document.getElementById('qList'); l.innerHTML=""; document.getElementById('qCount').innerText=qs.length;
        qs.forEach((q,i)=>{ const d=document.createElement('div'); d.className='q-item'; d.innerHTML=`<div onclick="openModal(qs[${i}],${i})" style="flex:1"><b>${i+1}.</b> ${q.q}</div><button style="width:30px;background:none;border:none;" onclick="event.stopPropagation();deleteQ(${i})">üóë</button>`; l.appendChild(d); });
    }

    async function getBase64Code() {
        const resp = await fetch('./index.html');
        if(!resp.ok) return null;
        let html = await resp.text();
        const cfg = { qs: qs, bg: assets.bg, music: assets.music, shuffle: document.getElementById('shuffleMode').value==='true' };
        // –í—Å—Ç–∞–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ index.html
        html = html.replace('if(window.GAME_CFG) DATA = window.GAME_CFG;', `window.GAME_CFG=${JSON.stringify(cfg)}; DATA=window.GAME_CFG;`);
        return "data:text/html;charset=utf-8;base64," + btoa(unescape(encodeURIComponent(html)));
    }

    async function updatePreview() {
        if(!qs.length && !assets.bg) return;
        const url = await getBase64Code();
        if(url) document.getElementById('gameFrame').src = url;
    }

    async function copyCode() {
        if(!qs.length) return alert("–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã!");
        const url = await getBase64Code();
        const code = `<iframe src="${url}" width="100%" height="600" style="border:none;" allow="autoplay"></iframe>`;
        navigator.clipboard.writeText(code).then(()=>alert("‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
    }
    
    updatePreview();
</script>
</body>
</html>
