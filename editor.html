<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Tower Editor</title>
    <style>
        :root { --bg: #051024; --panel: #0b1a36; --gold: #FFD700; --gold-dim: #b89b00; --text: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: 420px; background: var(--panel); border-right: 2px solid var(--gold); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; flex-shrink: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        h1 { font-size: 20px; text-align: center; border-bottom: 1px solid var(--gold-dim); padding-bottom: 15px; color: var(--gold); margin-top: 0; text-transform: uppercase; }
        
        .setting-group { border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; padding: 10px; background: rgba(0,0,0,0.2); margin-bottom: 10px; }
        label { display: block; font-size: 13px; color: var(--gold); margin-bottom: 5px; font-weight: bold; }
        
        .file-row { display: flex; align-items: center; gap: 10px; }
        .status { font-size: 11px; color: #aaa; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn { background: linear-gradient(180deg, var(--gold), var(--gold-dim)); color: #000; border: none; padding: 8px 12px; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; transition: 0.2s; font-size: 12px; }
        .btn:hover { filter: brightness(1.15); }
        .btn-icon { background: rgba(255,255,255,0.1); color: #fff; padding: 8px; width: 32px; text-align: center; }
        .btn-icon:hover { background: #ff4444; }
        
        .main-btn { width: 100%; font-size: 14px; padding: 12px; margin-top: 5px; }
        
        #qList { flex: 1; overflow-y: auto; margin: 20px 0; border-top: 1px solid rgba(255,215,0,0.2); padding-top: 10px; }
        .q-item { background: rgba(0,0,0,0.3); border: 1px solid var(--gold-dim); padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .q-item:hover { background: rgba(255,215,0,0.15); }
        
        .preview-area { flex: 1; background: #000; display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; }
        .preview-label { background: var(--gold); color: black; padding: 5px 10px; font-weight: bold; text-align: center; }

        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: var(--panel); border: 2px solid var(--gold); width: 500px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        input[type="text"], input[type="number"], select { width: 100%; padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; color: #000; }
        .ans-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>üèó –†–µ–¥–∞–∫—Ç–æ—Ä</h1>
    
    <div class="setting-group">
        <label>üñº –§–æ–Ω –∏–≥—Ä—ã:</label>
        <div class="file-row">
            <button class="btn" onclick="document.getElementById('bgFile').click()">üìÇ –í—ã–±—Ä–∞—Ç—å</button>
            <input type="file" id="bgFile" accept="image/*" style="display:none" onchange="handleFile('bg', this)">
            <span id="bgStatus" class="status">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
            <button class="btn btn-icon" onclick="resetFile('bg')" title="–£–¥–∞–ª–∏—Ç—å">‚ùå</button>
        </div>
        
        <label>üéµ –ú—É–∑—ã–∫–∞:</label>
        <div class="file-row">
            <button class="btn" onclick="document.getElementById('musicFile').click()">üìÇ –í—ã–±—Ä–∞—Ç—å</button>
            <input type="file" id="musicFile" accept="audio/*" style="display:none" onchange="handleFile('music', this)">
            <span id="musicStatus" class="status">–ù–µ—Ç</span>
            <button class="btn btn-icon" onclick="resetFile('music')" title="–£–¥–∞–ª–∏—Ç—å">‚ùå</button>
        </div>

        <label>üé≤ –ü–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
        <select id="shuffleMode" onchange="updatePreview()">
            <option value="false">–ü–æ –ø–æ—Ä—è–¥–∫—É (1 ‚Üí 2 ‚Üí 3...)</option>
            <option value="true">–°–ª—É—á–∞–π–Ω—ã–π (–ü–µ—Ä–µ–º–µ—à–∞—Ç—å)</option>
        </select>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
        <h3 style="margin:0; color:white;">–í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>)</h3>
        <button class="btn" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div id="qList"></div>

    <div style="margin-top:auto; padding-top:20px;">
        <button class="btn main-btn" onclick="copyCode()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
        <div style="text-align:center; font-size:11px; color:#888; margin-top:5px;">–î–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ Genially</div>
    </div>
</div>

<div class="preview-area">
    <div class="preview-label">–ü–†–ï–î–ü–†–û–°–ú–û–¢–†</div>
    <iframe id="gameFrame"></iframe>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <h2 style="text-align:center; color:var(--gold); margin-top:0;">–í–æ–ø—Ä–æ—Å</h2>
        
        <label>–¢–∏–ø:</label>
        <select id="mType" onchange="toggleType()">
            <option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
            <option value="input">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option>
        </select>

        <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
        <input type="text" id="mText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å...">

        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ / –ó–≤—É–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <div class="file-row" style="margin-bottom:5px;">
            <button class="btn" onclick="document.getElementById('mImg').click()">üì∑ –§–æ—Ç–æ</button>
            <input type="file" id="mImg" accept="image/*" style="display:none" onchange="handleMedia('img', this)">
            <span id="stImg" class="status">–ù–µ—Ç</span>
            <button class="btn btn-icon" onclick="clearMedia('img')">‚ùå</button>
        </div>
        <div class="file-row">
            <button class="btn" onclick="document.getElementById('mAud').click()">üéµ –ó–≤—É–∫</button>
            <input type="file" id="mAud" accept="audio/*" style="display:none" onchange="handleMedia('audio', this)">
            <span id="stAud" class="status">–ù–µ—Ç</span>
            <button class="btn btn-icon" onclick="clearMedia('audio')">‚ùå</button>
        </div>

        <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:5px; margin:15px 0;">
            <div class="file-row">
                <input type="checkbox" id="mTimer" style="width:auto;" onchange="toggleTimer()">
                <label style="margin:0; color:white; cursor:pointer;" for="mTimer">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</label>
                <input type="number" id="mSec" value="15" style="width:60px; display:none;">
            </div>
        </div>

        <div id="boxChoice">
            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã (–æ—Ç–º–µ—Ç—å—Ç–µ –≤–µ—Ä–Ω—ã–π):</label>
            <div id="ansList"></div>
            <button class="btn" style="margin-top:5px; background:#444; color:#fff;" onclick="addAnsRow()">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="boxInput" style="display:none;">
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
            <input type="text" id="mCorrect" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∞—Ä–∏–∂">
        </div>

        <div class="file-row" style="margin-top:25px; justify-content:flex-end;">
            <button class="btn" style="background:#444; color:#fff;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
    </div>
</div>

<script>
    let qs = [], editIdx = null, assets = { bg: null, music: null }, temp = {};

    function handleFile(key, inp) {
        if(!inp.files[0]) return;
        const r = new FileReader();
        r.onload = e => {
            assets[key] = e.target.result;
            document.getElementById(key+'Status').innerText = "–ó–∞–≥—Ä—É–∂–µ–Ω";
            document.getElementById(key+'Status').style.color = "#0f0";
            updatePreview();
        };
        r.readAsDataURL(inp.files[0]);
    }

    function resetFile(key) {
        assets[key] = null;
        const el = document.getElementById(key+'Status');
        el.innerText = key==='bg' ? "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é" : "–ù–µ—Ç";
        el.style.color = "#aaa";
        document.getElementById(key+'File').value = "";
        updatePreview();
    }

    function handleMedia(key, inp) {
        if(!inp.files[0]) return;
        const r = new FileReader();
        r.onload = e => {
            temp[key] = e.target.result;
            document.getElementById(key==='img'?'stImg':'stAud').innerText = "–ó–∞–≥—Ä—É–∂–µ–Ω";
        };
        r.readAsDataURL(inp.files[0]);
    }

    function clearMedia(key) {
        temp[key] = null;
        document.getElementById(key==='img'?'stImg':'stAud').innerText = "–ù–µ—Ç";
        document.getElementById(key==='img'?'mImg':'mAud').value = "";
    }

    // Modal
    function openModal(item = null, idx = null) {
        document.getElementById('modal').style.display = 'flex';
        temp = { img: null, audio: null };
        document.getElementById('stImg').innerText = "–ù–µ—Ç";
        document.getElementById('stAud').innerText = "–ù–µ—Ç";
        document.getElementById('ansList').innerHTML = "";
        
        if(item) {
            editIdx = idx;
            document.getElementById('mType').value = item.type;
            document.getElementById('mText').value = item.q;
            document.getElementById('mTimer').checked = !!item.timer;
            document.getElementById('mSec').value = item.timer || 15;
            if(item.img) { temp.img = item.img; document.getElementById('stImg').innerText = "–û–ö"; }
            if(item.audio) { temp.audio = item.audio; document.getElementById('stAud').innerText = "–û–ö"; }
            
            if(item.type === 'choice') {
                item.options.forEach(o => addAnsRow(o, o === item.answer));
            } else {
                document.getElementById('mCorrect').value = item.answer;
            }
        } else {
            editIdx = null;
            document.getElementById('mType').value = 'choice';
            document.getElementById('mText').value = "";
            document.getElementById('mTimer').checked = false;
            addAnsRow('', true); addAnsRow('');
        }
        toggleType(); toggleTimer();
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function toggleTimer() { document.getElementById('mSec').style.display = document.getElementById('mTimer').checked ? 'block' : 'none'; }
    
    function toggleType() {
        const isCh = document.getElementById('mType').value === 'choice';
        document.getElementById('boxChoice').style.display = isCh ? 'block' : 'none';
        document.getElementById('boxInput').style.display = isCh ? 'none' : 'block';
    }

    function addAnsRow(val = '', isCorrect = false) {
        const div = document.createElement('div');
        div.className = 'ans-row';
        div.innerHTML = `
            <input type="radio" name="rad" style="width:auto;" ${isCorrect?'checked':''}>
            <input type="text" class="ans-val" value="${val}" placeholder="–û—Ç–≤–µ—Ç">
            <button class="btn btn-icon" style="padding:2px;" onclick="this.parentElement.remove()">√ó</button>
        `;
        document.getElementById('ansList').appendChild(div);
    }

    function saveQ() {
        const q = {
            type: document.getElementById('mType').value,
            q: document.getElementById('mText').value,
            img: temp.img, audio: temp.audio,
            timer: document.getElementById('mTimer').checked ? parseInt(document.getElementById('mSec').value) : null
        };
        
        if(!q.q.trim()) return alert("–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å");

        if(q.type === 'choice') {
            const rows = document.querySelectorAll('.ans-row');
            if(rows.length < 2) return alert("–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞");
            q.options = [];
            let ok = false;
            rows.forEach(r => {
                const txt = r.querySelector('.ans-val').value.trim();
                if(txt) {
                    q.options.push(txt);
                    if(r.querySelector('input[type=radio]').checked) { q.answer = txt; ok = true; }
                }
            });
            if(!ok) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç");
        } else {
            q.answer = document.getElementById('mCorrect').value.trim();
            if(!q.answer) return alert("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç");
        }

        if(editIdx !== null) qs[editIdx] = q; else qs.push(q);
        closeModal(); render(); updatePreview();
    }

    function deleteQ(i) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { qs.splice(i,1); render(); updatePreview(); } }

    function render() {
        const l = document.getElementById('qList');
        l.innerHTML = "";
        document.getElementById('qCount').innerText = qs.length;
        qs.forEach((q, i) => {
            const d = document.createElement('div');
            d.className = 'q-item';
            d.innerHTML = `
                <div onclick="openModal(qs[${i}], ${i})" style="flex:1"><b>${i+1}.</b> ${q.q}</div>
                <button class="btn btn-icon" onclick="deleteQ(${i})">üóë</button>
            `;
            l.appendChild(d);
        });
    }

    // PREVIEW & EXPORT
    async function getCode() {
        const resp = await fetch('./index.html');
        if(!resp.ok) return null;
        let html = await resp.text();
        const cfg = {
            qs: qs,
            bg: assets.bg,
            music: assets.music,
            shuffle: document.getElementById('shuffleMode').value === 'true'
        };
        // –í—à–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –≤ —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ
        return html.replace('<head>', `<head><script>window.GAME_CFG=${JSON.stringify(cfg)};<\/script>`);
    }

    async function updatePreview() {
        const code = await getCode();
        if(code) document.getElementById('gameFrame').srcdoc = code;
    }

    async function copyCode() {
        if(!qs.length) return alert("–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã!");
        const code = await getCode();
        const final = `<iframe srcdoc="${code.replace(/"/g, '&quot;')}" width="100%" height="100%" style="width:100%;height:600px;border:none;"></iframe>`;
        navigator.clipboard.writeText(final).then(()=>alert("‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"));
    }

    updatePreview();
</script>
</body>
</html>
