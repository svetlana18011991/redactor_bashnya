<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Editor - Origins</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar { width: 350px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.5); z-index: 10; }
        
        h1 { color: #FFD700; text-align: center; font-size: 18px; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 15px; }
        
        .group { background: #222; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #333; }
        label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; font-weight: bold; }
        
        button { background: #333; color: white; border: 1px solid #555; padding: 8px; width: 100%; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #FFD700; color: black; }
        
        .btn-main { background: #FFD700; color: black; font-weight: bold; border: none; padding: 12px; margin-top: 10px; }
        
        #qList { flex: 1; overflow-y: auto; margin: 15px 0; border-top: 1px solid #333; padding-top: 10px; }
        .q-item { background: #252525; padding: 8px; margin-bottom: 5px; border-left: 3px solid #FFD700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .q-item:hover { background: #333; }
        
        .preview { flex: 1; background: black; }
        iframe { width: 100%; height: 100%; border: none; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: #222; border: 1px solid #FFD700; padding: 20px; width: 400px; border-radius: 8px; }
        input, select { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>üèó EDITOR: ORIGINS</h1>
    
    <div class="group">
        <label>–§–æ–Ω –∏–≥—Ä—ã:</label>
        <button onclick="document.getElementById('bgInp').click()">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="bgInp" hidden onchange="loadFile('bg', this)">
        <div id="st_bg" style="font-size:11px; color:#555; margin-top:5px;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (–∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)</div>
    </div>

    <div class="group">
        <label>–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞:</label>
        <button onclick="document.getElementById('musInp').click()">üéµ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="musInp" hidden onchange="loadFile('music', this)">
        <div id="st_music" style="font-size:11px; color:#555; margin-top:5px;">–ù–µ—Ç</div>
    </div>

    <div class="group">
        <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</label>
        <select id="shuffleMode" onchange="update()">
            <option value="false">–ü–æ –ø–æ—Ä—è–¥–∫—É (1, 2, 3...)</option>
            <option value="true">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</option>
        </select>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:12px; font-weight:bold; color:#888;">–í–û–ü–†–û–°–´</span>
        <button style="width:auto; font-size:12px; padding:5px 10px;" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="qList"></div>

    <div style="margin-top:auto;">
        <button class="btn-main" onclick="copyCode()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
        <div style="text-align:center; font-size:10px; color:#666; margin-top:5px;">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Genially</div>
    </div>
</div>

<div class="preview">
    <iframe id="frame"></iframe>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="color:#FFD700; margin-top:0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        
        <label>–¢–∏–ø:</label>
        <select id="mType" onchange="toggleType()"><option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option><option value="input">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option></select>
        
        <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
        <input id="mQ" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2 + 2 = ?">
        
        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∫ –≤–æ–ø—Ä–æ—Å—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <button onclick="document.getElementById('mImgInp').click()">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <input type="file" id="mImgInp" hidden onchange="loadMedia(this)">
        <div id="st_mImg" style="font-size:11px; color:#555; margin-bottom:10px;">–ù–µ—Ç</div>

        <div style="background:#333; padding:10px; border-radius:4px; margin-bottom:10px;">
            <label style="margin:0;"><input type="checkbox" id="mTimer" onchange="toggleTimer()"> –¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
            <input type="number" id="mSec" value="15" style="display:none; margin-top:5px;">
        </div>

        <div id="boxChoice">
            <label>–í–∞—Ä–∏–∞–Ω—Ç—ã (–æ—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):</label>
            <div id="ansList"></div>
            <button onclick="addAns()" style="margin-top:5px;">+ –í–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="boxInput" style="display:none;">
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç/—á–∏—Å–ª–æ):</label>
            <input id="mAns">
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal()" style="background:#444;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="saveQ()" class="btn-main" style="margin:0;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    let qs = [], editId = null, assets = { bg: null, music: null }, tempImg = null;

    function loadFile(type, input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            assets[type] = e.target.result;
            document.getElementById('st_'+type).innerText = "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!";
            document.getElementById('st_'+type).style.color = "#0f0";
            update();
        };
        reader.readAsDataURL(file);
    }

    function loadMedia(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            tempImg = e.target.result;
            document.getElementById('st_mImg').innerText = "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã–±—Ä–∞–Ω–∞";
            document.getElementById('st_mImg').style.color = "#0f0";
        };
        reader.readAsDataURL(file);
    }

    // Modal Logic
    function openModal(q = null, idx = null) {
        document.getElementById('modal').style.display = 'flex';
        tempImg = null; document.getElementById('st_mImg').innerText = "–ù–µ—Ç"; document.getElementById('st_mImg').style.color="#555";
        document.getElementById('ansList').innerHTML = "";
        
        if (q) {
            editId = idx;
            document.getElementById('mType').value = q.type;
            document.getElementById('mQ').value = q.q;
            if(q.img) { tempImg = q.img; document.getElementById('st_mImg').innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞"; }
            
            document.getElementById('mTimer').checked = !!q.timer;
            if(q.timer) {
                document.getElementById('mSec').style.display = 'block';
                document.getElementById('mSec').value = q.timer;
            } else {
                document.getElementById('mSec').style.display = 'none';
            }

            if(q.type === 'choice') {
                q.options.forEach(opt => addAns(opt, opt === q.answer));
            } else {
                document.getElementById('mAns').value = q.answer;
            }
        } else {
            editId = null;
            document.getElementById('mType').value = 'choice';
            document.getElementById('mQ').value = "";
            document.getElementById('mTimer').checked = false;
            document.getElementById('mSec').style.display = 'none';
            document.getElementById('mAns').value = "";
            addAns("", true); addAns("");
        }
        toggleType();
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    function toggleType() {
        const isCh = document.getElementById('mType').value === 'choice';
        document.getElementById('boxChoice').style.display = isCh ? 'block' : 'none';
        document.getElementById('boxInput').style.display = isCh ? 'none' : 'block';
    }

    function toggleTimer() {
        document.getElementById('mSec').style.display = document.getElementById('mTimer').checked ? 'block' : 'none';
    }

    function addAns(val = "", isCorrect = false) {
        const div = document.createElement('div');
        div.style.display = "flex"; div.style.marginBottom = "5px";
        div.innerHTML = `
            <input type="radio" name="rad" style="width:auto; margin-right:5px;" ${isCorrect?'checked':''}>
            <input class="ans-val" value="${val}" style="margin:0;">
            <button style="width:30px; margin-left:5px;" onclick="this.parentElement.remove()">√ó</button>
        `;
        document.getElementById('ansList').appendChild(div);
    }

    function saveQ() {
        const q = {
            type: document.getElementById('mType').value,
            q: document.getElementById('mQ').value,
            img: tempImg,
            timer: document.getElementById('mTimer').checked ? parseInt(document.getElementById('mSec').value) : null
        };

        if(q.type === 'choice') {
            q.options = [];
            const rows = document.querySelectorAll('#ansList div');
            rows.forEach(r => {
                const val = r.querySelector('.ans-val').value.trim();
                if(val) {
                    q.options.push(val);
                    if(r.querySelector('input[type=radio]').checked) q.answer = val;
                }
            });
            if(!q.answer) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞!");
        } else {
            q.answer = document.getElementById('mAns').value.trim();
        }

        if(editId !== null) qs[editId] = q; else qs.push(q);
        closeModal(); render(); update();
    }

    function render() {
        const list = document.getElementById('qList');
        list.innerHTML = "";
        qs.forEach((q, i) => {
            list.innerHTML += `
                <div class="q-item" onclick="openModal(qs[${i}], ${i})">
                    <span>${i+1}. ${q.q}</span>
                    <span onclick="event.stopPropagation(); qs.splice(${i},1); render(); update();">üóë</span>
                </div>`;
        });
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê ===
    async function getCode() {
        // –ë–µ—Ä–µ–º –Ω–æ–≤—ã–π index.html
        const resp = await fetch('./index.html');
        if(!resp.ok) return null;
        let html = await resp.text();
        
        const cfg = {
            qs: qs,
            bg: assets.bg,
            music: assets.music,
            shuffle: document.getElementById('shuffleMode').value === 'true'
        };

        // –í–Ω–µ–¥—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥
        html = html.replace(
            "if(window.GAME_CFG) DATA = window.GAME_CFG;", 
            `window.GAME_CFG = ${JSON.stringify(cfg)}; DATA = window.GAME_CFG;`
        );

        return "data:text/html;charset=utf-8;base64," + btoa(unescape(encodeURIComponent(html)));
    }

    async function update() {
        const url = await getCode();
        if(url) document.getElementById('frame').src = url;
    }

    async function copyCode() {
        if(qs.length === 0) return alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!");
        const url = await getCode();
        const code = `<iframe src="${url}" width="100%" height="600" style="border:none;" allow="autoplay"></iframe>`;
        navigator.clipboard.writeText(code).then(() => alert("‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ Genially (Insert -> Other)."));
    }

    // –°—Ç–∞—Ä—Ç
    update();
</script>
</body>
</html>
