<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Tower Editor</title>
    <style>
        body{font-family:sans-serif;background:#111;color:white;display:flex;height:100vh;margin:0;}
        .col{padding:20px;display:flex;flex-direction:column;}
        .left{width:350px;background:#222;border-right:1px solid gold;overflow-y:auto;}
        .right{flex:1;background:black;display:flex;flex-direction:column;}
        h1{color:gold;text-align:center;font-size:18px;}
        .group{border:1px solid #444;padding:10px;margin-bottom:10px;border-radius:5px;}
        button{cursor:pointer;background:#444;color:white;border:1px solid #666;padding:5px;width:100%;margin-top:5px;}
        button:hover{background:gold;color:black;}
        input,select{width:100%;background:#fff;color:black;padding:5px;box-sizing:border-box;margin-bottom:5px;}
        .q-item{background:#333;padding:5px;margin-bottom:5px;display:flex;justify-content:space-between;cursor:pointer;}
        iframe{flex:1;border:none;}
        /* Modal */
        #modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;}
        .modal-box{background:#222;border:2px solid gold;padding:20px;width:400px;}
    </style>
</head>
<body>

<div class="col left">
    <h1>üèó –†–ï–î–ê–ö–¢–û–† v7.0</h1>
    
    <div class="group">
        <label>–§–æ–Ω:</label>
        <button onclick="document.getElementById('bgFile').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="bgFile" hidden onchange="loadFile('bg',this)">
        <small id="st_bg" style="color:#aaa">–°—Ç–∞–Ω–¥–∞—Ä—Ç</small>
        <button onclick="reset('bg')" style="background:#522">–°–±—Ä–æ—Å</button>
    </div>

    <div class="group">
        <label>–ú—É–∑—ã–∫–∞:</label>
        <button onclick="document.getElementById('mFile').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="mFile" hidden onchange="loadFile('music',this)">
        <small id="st_music" style="color:#aaa">–ù–µ—Ç</small>
        <button onclick="reset('music')" style="background:#522">–°–±—Ä–æ—Å</button>
    </div>

    <div class="group">
        <label>–ü–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
        <select id="shuf" onchange="upd()"><option value="false">–ü–æ –ø–æ—Ä—è–¥–∫—É</option><option value="true">–°–ª—É—á–∞–π–Ω—ã–π</option></select>
    </div>

    <h3>–í–æ–ø—Ä–æ—Å—ã:</h3>
    <button onclick="openM()">+ –î–û–ë–ê–í–ò–¢–¨</button>
    <div id="list"></div>

    <div style="margin-top:auto">
        <button onclick="copy()" style="background:gold;color:black;font-weight:bold;padding:15px;">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
        <div style="text-align:center;font-size:10px;color:#888;">–í—Å—Ç–∞–≤—å—Ç–µ –≤ Genially (Insert -> Other)</div>
    </div>
</div>

<div class="col right">
    <iframe id="fr"></iframe>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 style="color:gold;margin-top:0">–í–æ–ø—Ä–æ—Å</h3>
        <select id="type" onchange="toggleType()"><option value="choice">–í—ã–±–æ—Ä</option><option value="input">–í–≤–æ–¥</option></select>
        <input id="qtext" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞">
        
        <div style="display:flex;gap:5px;">
            <button onclick="document.getElementById('qImg').click()">–ö–∞—Ä—Ç–∏–Ω–∫–∞</button>
            <input type="file" id="qImg" hidden onchange="loadMedia('img',this)">
            <span id="st_qimg" style="font-size:10px;">-</span>
        </div>

        <div style="margin:10px 0;">
            <label><input type="checkbox" id="timer" onchange="document.getElementById('tsec').style.display=this.checked?'inline':'none'"> –¢–∞–π–º–µ—Ä</label>
            <input type="number" id="tsec" value="15" style="width:50px;display:none">
        </div>

        <div id="ansBox">
            <div id="ansList"></div>
            <button onclick="addAns()">+ –û—Ç–≤–µ—Ç</button>
        </div>
        <div id="inpBox" style="display:none">
            <input id="corr" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç">
        </div>

        <div style="display:flex;gap:10px;margin-top:20px;">
            <button onclick="closeM()" style="background:#444">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="save()" style="background:gold;color:black">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
let qs=[], assets={bg:null,music:null}, curMedia={img:null}, editId=null;

function loadFile(k,el){ 
    const r=new FileReader(); r.onload=e=>{ assets[k]=e.target.result; document.getElementById('st_'+k).innerText="–ó–∞–≥—Ä—É–∂–µ–Ω"; document.getElementById('st_'+k).style.color="lime"; upd(); }; 
    if(el.files[0]) r.readAsDataURL(el.files[0]); 
}
function reset(k){ assets[k]=null; document.getElementById('st_'+k).innerText="–ù–µ—Ç"; upd(); }

function loadMedia(k,el){
    const r=new FileReader(); r.onload=e=>{ curMedia[k]=e.target.result; document.getElementById('st_qimg').innerText="OK"; };
    if(el.files[0]) r.readAsDataURL(el.files[0]);
}

function openM(q=null,id=null){
    document.getElementById('modal').style.display='flex';
    curMedia={img:null}; document.getElementById('st_qimg').innerText="-";
    document.getElementById('ansList').innerHTML="";
    if(q){
        editId=id; document.getElementById('type').value=q.type; document.getElementById('qtext').value=q.q;
        if(q.img){ curMedia.img=q.img; document.getElementById('st_qimg').innerText="OK"; }
        document.getElementById('timer').checked=!!q.timer; document.getElementById('tsec').value=q.timer||15;
        if(q.type==='choice') q.options.forEach(o=>addAns(o,o===q.answer));
        else document.getElementById('corr').value=q.answer;
    } else {
        editId=null; document.getElementById('qtext').value=""; addAns('',true); addAns('');
    }
    toggleType();
}
function closeM(){ document.getElementById('modal').style.display='none'; }

function toggleType(){
    const isCh=document.getElementById('type').value==='choice';
    document.getElementById('ansBox').style.display=isCh?'block':'none';
    document.getElementById('inpBox').style.display=isCh?'none':'block';
}

function addAns(val='',ok=false){
    const d=document.createElement('div'); d.style.display='flex'; d.style.marginBottom='5px';
    d.innerHTML=`<input type="radio" name="rad" ${ok?'checked':''}><input class="aval" value="${val}" style="margin:0 5px"><button style="width:30px" onclick="this.parentElement.remove()">x</button>`;
    document.getElementById('ansList').appendChild(d);
}

function save(){
    const q={
        type:document.getElementById('type').value,
        q:document.getElementById('qtext').value,
        img:curMedia.img,
        timer:document.getElementById('timer').checked?+document.getElementById('tsec').value:null
    };
    if(q.type==='choice'){
        q.options=[]; 
        document.querySelectorAll('#ansList div').forEach(d=>{
            const v=d.querySelector('.aval').value;
            if(v) { q.options.push(v); if(d.querySelector('input[type=radio]').checked) q.answer=v; }
        });
        if(!q.answer) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!");
    } else {
        q.answer=document.getElementById('corr').value;
    }
    if(editId!==null) qs[editId]=q; else qs.push(q);
    closeM(); render(); upd();
}

function render(){
    const l=document.getElementById('list'); l.innerHTML="";
    qs.forEach((q,i)=>{
        l.innerHTML+=`<div class="q-item" onclick="openM(qs[${i}],${i})"><span>${i+1}. ${q.q}</span><button style="width:30px" onclick="event.stopPropagation();qs.splice(${i},1);render();upd()">x</button></div>`;
    });
}

async function getCode(){
    const res=await fetch('./index.html');
    let txt=await res.text();
    const cfg={qs, bg:assets.bg, music:assets.music, shuffle:document.getElementById('shuf').value==='true'};
    txt = txt.replace('// –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥', `window.GAME_CFG=${JSON.stringify(cfg)};`);
    return "data:text/html;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(txt)));
}

async function upd(){
    const url=await getCode();
    document.getElementById('fr').src=url;
}

async function copy(){
    const url=await getCode();
    const code=`<iframe src="${url}" width="100%" height="600" style="border:none"></iframe>`;
    navigator.clipboard.writeText(code).then(()=>alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"));
}

upd();
</script>
</body>
</html>
